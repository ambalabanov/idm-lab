# Log IPA
module(load="imfile")

template(name="RsyslogForwardFormat" type="list" option.jsonf="on") {
	property(outname="@timestamp" name="timereported" dateFormat="rfc3339" format="jsonf")
	property(outname="hostname" name="hostname" format="jsonf")
	property(outname="tags" name="syslogtag" format="jsonf")
	property(outname="message" name="msg" format="jsonf")
}

$PreserveFQDN on

ruleset(name="sendToRsyslog") {
    action(
        type="omfwd"
        Target="logstash.idm.lab"
        Port="514"
        Protocol="udp"
        Template="RsyslogForwardFormat")
}

# for debugging only
ruleset(name="sendToFile") {
	action(
		type="omfile"
		File="/var/log/ipamessages"
		Template="RsyslogForwardFormat")
}

ruleset(name="sendToAll") {
    call sendToRsyslog
    call sendToFile 
}

# Read files
input(type="imfile"
    File="/var/log/krb5kdc.log"
    Tag="krb5kdc"
    Ruleset="sendToAll"
    addMetadata="on"
    reopenOnTruncate="on")

input(type="imfile"
    File="/var/log/kadmind.log"
    Tag="kadmind"
    Ruleset="sendToAll"
    addMetadata="on"
    reopenOnTruncate="on")

input(type="imfile"
    File="/var/log/dirsrv/slapd-IDM-LAB/audit"
    Tag="ds-audit"
    Ruleset="sendToAll"
    addMetadata="on"
    startmsg.regex="^time:"
    reopenOnTruncate="on")

input(type="imfile"
    File="/var/log/dirsrv/slapd-IDM-LAB/access"
    Tag="ds-access"
    Ruleset="sendToAll"
    addMetadata="on"
    reopenOnTruncate="on")

input(type="imfile"
    File="/var/log/dirsrv/slapd-IDM-LAB/errors"
    Tag="ds-errors"
    Ruleset="sendToAll"
    addMetadata="on"
    reopenOnTruncate="on")

input(type="imfile"
    File="/var/log/httpd/access_log"
    Tag="httpd-access"
    Ruleset="sendToAll"
    addMetadata="on"
    reopenOnTruncate="on")

input(type="imfile"
    File="/var/log/httpd/error_log"
    Tag="httpd-error"
    Ruleset="sendToAll"
    addMetadata="on"
    reopenOnTruncate="on")

input(type="imfile"
    File="/var/log/secure"
    Tag="secure"
    Ruleset="sendToAll"
    addMetadata="on"
    reopenOnTruncate="on")

